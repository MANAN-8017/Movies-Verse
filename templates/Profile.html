{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ request.user.username }} - MoviesVerse Profile</title>
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <link rel="stylesheet" href="{% static 'css/profile.css' %}">
</head>
<script>
    document.addEventListener("click", function (e) {
        const dropdown = document.querySelector(".profile-dropdown");
        dropdown.classList.toggle("active", dropdown.contains(e.target));
    });
</script>
<body>
    <!-- NAVBAR -->
    <div class="navbar">
        <div class="logo"><a href="{% url 'index' %}" style="text-decoration: none; color: #f5c518;">MoviesVerse</a></div>
        <div class="search-box">
            <input type="text" placeholder="Search movies, TV shows...">
            <button>Search</button>
        </div>
        <div class="nav-links">
            <a href="{% url 'index' %}">Movies</a>
            <a href="{% url 'watchlist' %}">Watchlist</a>
            <div class="profile-dropdown">
                {% if request.user.is_authenticated and request.user.profile.profile_pic %}
                    <img src="{{ request.user.profile.profile_pic.url }}" class="profile-avatar" alt="Profile">
                {% else %}
                    <img src="{% static 'images/default_pfp.jpeg' %}" class="profile-avatar" alt="Default Profile">
                {% endif %}
                <div class="dropdown-menu">
                        <a href="{% url 'watched' %}">Watched</a>
                        <a href="{% url 'favourite' %}">Favourite Movies</a>
                        <a href="{% url 'settings' %}">Settings</a>
                        <hr>
                        <a href="{% url 'logout' %}" class="logout">Logout</a>
                </div>
            </div>
        </div>
    </div>

    <!-- ‚îÄ‚îÄ PROFILE HERO BANNER ‚îÄ‚îÄ -->
    <div class="profile-banner">
        <div class="banner-overlay"></div>
        <div class="profile-hero-content">
            <div class="profile-hero-avatar-wrap">
                {% if request.user.is_authenticated and request.user.profile.profile_pic %}
                    <img src="{{ request.user.profile.profile_pic.url }}" class="profile-hero-avatar" alt="Profile">
                {% else %}
                    <img src="{% static 'images/default_pfp.jpeg' %}" class="profile-hero-avatar" alt="Default Profile">
                {% endif %}
                <div class="cinephile-badge" title="Cinephile">üé¨</div>
            </div>
            <div class="profile-hero-info">
                <h1 class="profile-hero-name">{{ request.user.profile.display_name|default:request.user.username }}</h1>
                <div class="profile-hero-handle">@{{ request.user.username }}</div>
                <div class="profile-hero-bio">{{ request.user.profile.bio|default:"No bio yet. Edit your profile to add one." }}</div>
                <div class="profile-hero-meta">
                    <span>üé≠ Favourite: {{ request.user.profile.fav_genre|default:"Not set"|capfirst }}</span>
                    <span>üìÖ Joined {{ request.user.date_joined|date:"F Y" }}</span>
                </div>
            </div>
            <div class="profile-hero-actions">
                <a href="{% url 'settings' %}" class="btn-edit-profile">‚úé Edit Profile</a>
            </div>
        </div>
    </div>

    <!-- ‚îÄ‚îÄ STATS ROW ‚îÄ‚îÄ -->
    <div class="stats-row-wrap">
        <div class="stats-row">
            <div class="stat-pill">
                <span class="stat-num">{{ total_watched|default:"0" }}</span>
                <span class="stat-label">Movies Watched</span>
            </div>
            <div class="stat-divider"></div>
            <div class="stat-pill">
                <span class="stat-num">{{ watchlist_count|default:"0" }}</span>
                <span class="stat-label">Watchlist</span>
            </div>
            <div class="stat-divider"></div>
            <div class="stat-pill">
                <span class="stat-num">{{ favourites_count|default:"0" }}</span>
                <span class="stat-label">Favourites</span>
            </div>
            <div class="stat-divider"></div>
            <div class="stat-pill">
                <span class="stat-num">{{ ratings_count|default:"0" }}</span>
                <span class="stat-label">Ratings</span>
            </div>
            <div class="stat-divider"></div>
            <div class="stat-pill">
                <span class="stat-num">{{ comments_count|default:"0" }}</span>
                <span class="stat-label">Reviews</span>
            </div>
            <div class="stat-divider"></div>
            <div class="stat-pill">
                <span class="stat-num">{{ likes_count|default:"0" }}</span>
                <span class="stat-label">Likes Given</span>
            </div>
        </div>
    </div>

    <!-- ‚îÄ‚îÄ TIME TRACKER CARD ‚îÄ‚îÄ -->
    <div class="profile-body">

        <div class="time-tracker-card">
            <div class="time-tracker-label">‚è± Total Time Spent Watching</div>
            <div class="time-tracker-values">
                <div class="time-unit">
                    <span class="time-num" id="t-years">{{ time_years|default:"0" }}</span>
                    <span class="time-text">yrs</span>
                </div>
                <span class="time-sep">:</span>
                <div class="time-unit">
                    <span class="time-num" id="t-months">{{ time_months|default:"0" }}</span>
                    <span class="time-text">mo</span>
                </div>
                <span class="time-sep">:</span>
                <div class="time-unit">
                    <span class="time-num" id="t-days">{{ time_days|default:"0" }}</span>
                    <span class="time-text">days</span>
                </div>
                <span class="time-sep">:</span>
                <div class="time-unit">
                    <span class="time-num" id="t-hours">{{ time_hours|default:"0" }}</span>
                    <span class="time-text">hrs</span>
                </div>
            </div>
            <div class="time-tracker-sub">Across {{ total_watched|default:"0" }} films ‚Ä¢ Avg {{ avg_runtime|default:"~118" }} min per film</div>
        </div>

        <!-- ‚îÄ‚îÄ TAB NAV ‚îÄ‚îÄ -->
        <div class="profile-tabs">
            <button class="tab-btn active" data-tab="currently-watching">‚ñ∂ Watching</button>
            <button class="tab-btn" data-tab="watchlist-tab">üéØ Watchlist</button>
            <button class="tab-btn" data-tab="watched-tab">‚úÖ Watched</button>
            <button class="tab-btn" data-tab="favourites-tab">‚ù§Ô∏è Favourites</button>
            <button class="tab-btn" data-tab="ratings-tab">‚≠ê Ratings</button>
            <button class="tab-btn" data-tab="comments-tab">üí¨ Reviews</button>
            <button class="tab-btn" data-tab="likes-tab">üëç Likes</button>
            <button class="tab-btn" data-tab="history-tab">üîç Search History</button>
        </div>

        <!-- ‚îÄ‚îÄ CURRENTLY WATCHING ‚îÄ‚îÄ -->
        <div id="currently-watching" class="tab-content active-tab">
            <div class="section-label">Currently Watching</div>
            {% if currently_watching %}
                <div class="profile-movie-grid">
                    {% for movie in currently_watching %}
                    <div class="profile-movie-card watching-card">
                        <div class="card-poster-wrap">
                            <a href="{% url 'movie_detail' movie.tmdb_id %}">
                                <img src="{{ movie.poster }}" alt="{{ movie.title }}" class="profile-card-img">
                            </a>
                            <div class="watching-tag">‚ñ∂ Watching</div>
                            <div class="progress-bar-wrap">
                                <!-- <div class="progress-bar-fill" style="width: {{ movie.progress|default:0 }}%"></div> -->
                            </div>
                        </div>
                        <div class="profile-card-info">
                            <div class="profile-card-title">{{ movie.title }}</div>
                            <div class="profile-card-meta">{{ movie.progress|default:0 }}% complete</div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="empty-state">
                    <span class="empty-icon">üçø</span>
                    <p>No movies in progress right now.</p>
                    <a href="{% url 'index' %}" class="btn-gold-sm">Browse Movies</a>
                </div>
            {% endif %}
        </div>

        <!-- ‚îÄ‚îÄ WATCHLIST ‚îÄ‚îÄ -->
        <div id="watchlist-tab" class="tab-content">
            <div class="section-label">My Watchlist <span class="count-badge">{{ watchlist_count|default:"0" }}</span></div>
            {% if watchlist_movies %}
                <div class="profile-movie-grid">
                    {% for movie in watchlist_movies %}
                    <div class="profile-movie-card">
                        <div class="card-poster-wrap">
                            <a href="{% url 'movie_detail' movie.tmdb_id %}">
                                <img src="{{ movie.poster }}" alt="{{ movie.title }}" class="profile-card-img">
                            </a>
                        </div>
                        <div class="profile-card-info">
                            <div class="profile-card-title">{{ movie.title }}</div>
                            <div class="profile-card-meta">{{ movie.release_year }}</div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="empty-state">
                    <span class="empty-icon">üìã</span>
                    <p>Your watchlist is empty. Start adding movies!</p>
                    <a href="{% url 'index' %}" class="btn-gold-sm">Explore Movies</a>
                </div>
            {% endif %}
        </div>

        <!-- ‚îÄ‚îÄ WATCHED ‚îÄ‚îÄ -->
        <div id="watched-tab" class="tab-content">
            <div class="section-label">Watched Movies <span class="count-badge">{{ total_watched|default:"0" }}</span></div>
            {% if watched_movies %}
                <div class="profile-movie-grid">
                    {% for movie in watched_movies %}
                    <div class="profile-movie-card">
                        <div class="card-poster-wrap">
                            <a href="{% url 'movie_detail' movie.tmdb_id %}">
                                <img src="{{ movie.poster }}" alt="{{ movie.title }}" class="profile-card-img">
                            </a>
                            <div class="watched-tick">‚úì</div>
                        </div>
                        <div class="profile-card-info">
                            <div class="profile-card-title">{{ movie.title }}</div>
                            <div class="profile-card-meta">{{ movie.watched_on|date:"M d, Y" }}</div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="empty-state">
                    <span class="empty-icon">üé•</span>
                    <p>No watched movies logged yet.</p>
                </div>
            {% endif %}
        </div>

        <!-- ‚îÄ‚îÄ FAVOURITES ‚îÄ‚îÄ -->
        <div id="favourites-tab" class="tab-content">
            <div class="section-label">Favourite Movies <span class="count-badge">{{ favourites_count|default:"0" }}</span></div>
            {% if favourite_movies %}
                <div class="profile-movie-grid">
                    {% for movie in favourite_movies %}
                    <div class="profile-movie-card">
                        <div class="card-poster-wrap">
                            <a href="{% url 'movie_detail' movie.tmdb_id %}">
                                <img src="{{ movie.poster }}" alt="{{ movie.title }}" class="profile-card-img">
                            </a>
                            <div class="fav-heart">‚ù§Ô∏è</div>
                        </div>
                        <div class="profile-card-info">
                            <div class="profile-card-title">{{ movie.title }}</div>
                            <div class="profile-card-meta">{{ movie.release_year }}</div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="empty-state">
                    <span class="empty-icon">‚ù§Ô∏è</span>
                    <p>No favourites yet. Heart movies you love!</p>
                </div>
            {% endif %}
        </div>

        <!-- ‚îÄ‚îÄ RATINGS ‚îÄ‚îÄ -->
        <div id="ratings-tab" class="tab-content">
            <div class="section-label">My Ratings <span class="count-badge">{{ ratings_count|default:"0" }}</span></div>
            {% if rated_movies %}
                <div class="ratings-list">
                    {% for item in rated_movies %}
                    <div class="rating-row">
                        <a href="{% url 'movie_detail' item.movie.tmdb_id %}" class="rating-poster">
                            <img src="{{ item.movie.poster }}" alt="{{ item.movie.title }}">
                        </a>
                        <div class="rating-info">
                            <div class="rating-title">{{ item.movie.title }}</div>
                            <div class="rating-year">{{ item.movie.release_year }}</div>
                            <div class="rating-date">Rated on {{ item.rated_on|date:"M d, Y" }}</div>
                        </div>
                        <div class="rating-stars-display">
                            {% for i in "12345" %}
                                <span class="{% if forloop.counter <= item.rating %}star-filled{% else %}star-empty{% endif %}">‚òÖ</span>
                            {% endfor %}
                            <span class="rating-val">{{ item.rating }}/5</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="empty-state">
                    <span class="empty-icon">‚≠ê</span>
                    <p>You haven't rated any movies yet.</p>
                </div>
            {% endif %}
        </div>

        <!-- ‚îÄ‚îÄ REVIEWS / COMMENTS ‚îÄ‚îÄ -->
        <div id="comments-tab" class="tab-content">
            <div class="section-label">My Reviews <span class="count-badge">{{ comments_count|default:"0" }}</span></div>
            {% if user_comments %}
                <div class="reviews-list">
                    {% for comment in user_comments %}
                    <div class="review-card">
                        <a href="{% url 'movie_detail' comment.movie.tmdb_id %}" class="review-poster-mini">
                            <img src="{{ comment.movie.poster }}" alt="{{ comment.movie.title }}">
                        </a>
                        <div class="review-body">
                            <div class="review-movie-title">
                                <a href="{% url 'movie_detail' comment.movie.tmdb_id %}">{{ comment.movie.title }}</a>
                            </div>
                            <div class="review-stars">
                                {% for i in "12345" %}
                                    <span class="{% if comment.rating and forloop.counter <= comment.rating %}star-filled{% else %}star-empty{% endif %}">‚òÖ</span>
                                {% endfor %}
                            </div>
                            <p class="review-text">{{ comment.text }}</p>
                            <div class="review-meta">
                                <span>{{ comment.created_at|date:"M d, Y" }}</span>
                                <span>üëç {{ comment.likes|default:"0" }} likes</span>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="empty-state">
                    <span class="empty-icon">üí¨</span>
                    <p>You haven't written any reviews yet.</p>
                </div>
            {% endif %}
        </div>

        <!-- ‚îÄ‚îÄ LIKES ‚îÄ‚îÄ -->
        <div id="likes-tab" class="tab-content">
            <div class="section-label">Movies You Liked <span class="count-badge">{{ likes_count|default:"0" }}</span></div>
            {% if liked_movies %}
                <div class="profile-movie-grid">
                    {% for movie in liked_movies %}
                    <div class="profile-movie-card">
                        <div class="card-poster-wrap">
                            <a href="{% url 'movie_detail' movie.tmdb_id %}">
                                <img src="{{ movie.poster }}" alt="{{ movie.title }}" class="profile-card-img">
                            </a>
                            <div class="like-badge">üëç</div>
                        </div>
                        <div class="profile-card-info">
                            <div class="profile-card-title">{{ movie.title }}</div>
                            <div class="profile-card-meta">{{ movie.release_year }}</div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="empty-state">
                    <span class="empty-icon">üëç</span>
                    <p>No liked movies yet.</p>
                </div>
            {% endif %}
        </div>

        <!-- ‚îÄ‚îÄ SEARCH HISTORY ‚îÄ‚îÄ -->
        <div id="history-tab" class="tab-content">
            <div class="section-label-row">
                <div class="section-label">Search History</div>
                <button class="btn-outline-sm" onclick="clearSearchHistory()">üóë Clear All</button>
            </div>
            {% if search_history %}
                <div class="history-list">
                    {% for item in search_history %}
                    <div class="history-row">
                        <span class="history-icon">üîç</span>
                        <div class="history-info">
                            <span class="history-query">{{ item.query }}</span>
                            <span class="history-time">{{ item.searched_at|timesince }} ago</span>
                        </div>
                        <a href="{% url 'index' %}?q={{ item.query|urlencode }}" class="btn-history-search">Search again</a>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="empty-state">
                    <span class="empty-icon">üîç</span>
                    <p>No search history recorded yet.</p>
                </div>
            {% endif %}
        </div>

    </div><!-- /profile-body -->

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-links">
            <a href="{% url 'help' %}" class="footer-link">Help</a>
            <a href="{% url 'privacy_policy' %}" class="footer-link">Privacy Policy</a>
            <a href="{% url 'terms_of_use' %}" class="footer-link">Terms of Use</a>
        </div>
        <p class="footer-text">¬© 2026 MoviesVerse.com</p>
    </footer>
    <script>
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active-tab'));
                btn.classList.add('active');
                document.getElementById(btn.dataset.tab).classList.add('active-tab');
            });
        });

        const observer = new IntersectionObserver(entries => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.style.transition = 'width 1s ease';
                }
            });
        });
        document.querySelectorAll('.genre-bar-fill').forEach(bar => observer.observe(bar));
    </script>
</body>
</html>